<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!--three.js-->
<script src="three.js"></script>
<!--camera controls-->
<script src="FPControls.js"></script>
<!--open xml-->
<script src="openxml.js"></script>
<!--buildings tenements, commercials, factories-->
<script src="Buildings/tenements.js"></script>
<script src="Buildings/commercials.js"></script>
<script src="Buildings/factories.js"></script>
<!--buildings-->
<script src="Buildings/dpstore.js"></script>
<script src="Buildings/lbanks.js"></script>
<script src="Buildings/lhotels.js"></script>
<script src="Buildings/npapers.js"></script>
<script src="Buildings/radios.js"></script>
<script src="Buildings/stations.js"></script>
<script src="Buildings/movtheatres.js"></script>
<script src="Buildings/museums.js"></script>
<script src="Buildings/schools.js"></script>
<script src="Buildings/university.js"></script>
<script src="Buildings/orphanage.js"></script>
<script src="Buildings/churches.js"></script>
<script src="Buildings/synagogue.js"></script>
<script src="Buildings/policedep.js"></script>
<script src="Buildings/firedep.js"></script>
<script src="Buildings/fbi.js"></script>
<script src="Buildings/jail.js"></script>
<script src="Buildings/hospitals.js"></script>
<script src="Buildings/court.js"></script>
<script src="Buildings/cityhall.js"></script>
<script src="Buildings/postoffices.js"></script>
<script src="Buildings/warehouses.js"></script>
<!--test depot-->
<script src="Depot.js"></script>
<!--plane-->
<script src="Plane.js"></script>
<!--skybox-->
<script src="Skybox.js"></script>
<!--loaders-->
<script src="OBJLoader.js"></script>
<script src="MTLLoader.js"></script>
<script src="DDSLoader.js"></script>
<script src="ModelLoader.js"></script>
<!--collission detection-->
<script src="KeyboardState.js"></script>
<script src="Collision.js"></script>
<style>
.customcanvas {margin-left: auto; margin-right: auto; margin-top: 20px; width: 800px; height: 400px; display: block;
border-style: solid; border-width: 1px; border-color: #000000;}
p.ce {text-align: center;}
</style>
</head>
<body style="margin: 0px; background-color: #d8e7ff; overflow: hidden;">
<div height="400" width="800" class="customcanvas" id="customcanvas">
<script>
//keyboard
var keyboard = new THREEx.KeyboardState();
var clock = new THREE.Clock();

//collision vars
var MovingCube;
var collidableMeshList = []; 
       
//updater
var updateFcts = [];
//scene
var scene = new THREE.Scene();
//fog
scene.fog = new THREE.FogExp2( 0xd0e0f0, 0.0025 );
//renderer
var renderer = new THREE.WebGLRenderer( { antialias: false } );
//window
canvasWidth = 800;
canvasHeight = 400;
renderer.setSize( canvasWidth, canvasHeight );
        
//append object to it
document.getElementById("customcanvas").appendChild(renderer.domElement);

//camera
var camera = new THREE.PerspectiveCamera(45, canvasWidth / canvasHeight, 0.01, 8000);
camera.position.y = 12;
camera.position.z = 15;
camera.position.x = 15;

//lighting
var light        = new THREE.HemisphereLight( 0xfffff0, 0x101020, 1.25 );
light.position.set( 0.75, 1, 0.25 );
scene.add( light );

//plane                
var plane = new Plane();
scene.add(plane);

//skybox
var skyBox = new Skybox();
scene.add( skyBox );

//moving cube
var cubeGeometry = new THREE.CubeGeometry(50,50,50,1,1,1);
var wireMaterial = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe:true } );
MovingCube = new THREE.Mesh( cubeGeometry, wireMaterial );
MovingCube.position.set(camera.position.x + 75, camera.position.y + 18, camera.position.z);
scene.add( MovingCube );
//console.log(MovingCube);
//console.log( MovingCube.position.clone());
        
//Camera Controls
var controls        = new THREE.FirstPersonControls( camera );
controls.movementSpeed        = 80;
controls.lookSpeed            = 0.05;
controls.lookVertical         = true; //if true vertical look on mousemovement
updateFcts.push(function(delta, now){
                controls.update( delta );                
        })

// collision detection test
var wallGeometry = new THREE.CubeGeometry( 100, 100, 20, 1, 1, 1 );
var wallMaterial = new THREE.MeshBasicMaterial( {color: 0x8888ff} );
	
	var wall = new THREE.Mesh(wallGeometry, wallMaterial);
	wall.position.set(100, 50, -100);
	scene.add(wall);
	collidableMeshList.push(wall);


//test depot
//var ndepot = new Depot();
var dgeometry = new THREE.CubeGeometry(30, 60, 30,1,1,1);
        var dcubeMaterials = [
            new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load("textures/bricks.jpg"), side: THREE.DoubleSide }), //LEFT
            new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load("textures/bricks.jpg"), side: THREE.DoubleSide }), //RIGHT
            new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load("textures/bricks.jpg"), side: THREE.DoubleSide }), //TOP
            new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load("textures/bricks.jpg"), side: THREE.DoubleSide }), //BOTTOM
            new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load("textures/bricks.jpg"), side: THREE.DoubleSide }), //FRONT
            new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load("textures/bricks.jpg"), side: THREE.DoubleSide }), //BACK
            ];
        var dmaterial = new THREE.MeshFaceMaterial(dcubeMaterials);
        var ddepot = new THREE.Mesh(dgeometry, dmaterial);
        ddepot.position.x = 47;
        ddepot.position.y = 0;
        ddepot.position.z = 47;
//scene.add(ndepot);
scene.add(ddepot);
//collidableMeshList.push(ndepot);
collidableMeshList.push(ddepot);

//buildings to scene
//scene 1, max 1600 tenements
//var city = new THREEx.ProceduralCity()
//scene.add(city)

//scene 2, 8
//var dpstore = new THREEx.ProceduralDepStore()
//scene.add(dpstore)
var dpstore = new DepartmentStore();
scene.add(dpstore);

collidableMeshList.push(dpstore);  
    

function clearText()
{   document.getElementById('message').innerHTML = '..........';   }

function appendText(txt)
{   document.getElementById('message').innerHTML += txt;   }

        //update function
        updateFcts.push(function(){
                //render the scene
                renderer.render( scene, camera ); 

                var mcdelta = clock.getDelta(); // seconds.
                var moveDistance = 100 * mcdelta; // 200 pixels per second
                //var moveDistance = controls.movementSpeed;
                var mcrotateAngle = Math.PI / 2 * mcdelta;   // pi/2 radians (90 degrees) per second
                
                
                if ( keyboard.pressed("q") )
		MovingCube.rotation.y += mcrotateAngle; //rotate left
	        if ( keyboard.pressed("e") )
		MovingCube.rotation.y -= mcrotateAngle; //rotate right
                
                /*
	        if ( keyboard.pressed("d") )
                MovingCube.position.z += moveDistance; //left
                if ( keyboard.pressed("a") )
		MovingCube.position.z -= moveDistance; //right
	        if ( keyboard.pressed("w") )
                MovingCube.position.x += moveDistance; //up
                if ( keyboard.pressed("s") )
                MovingCube.position.x -= moveDistance; //down
                */

                MovingCube.position.x = camera.position.x + 75;
                MovingCube.position.y = camera.position.y + 18;
                MovingCube.position.z = camera.position.z;
                
                var originPoint = MovingCube.position.clone();

                clearText();
                
                //collision
                for (var vertexIndex = 0; vertexIndex < MovingCube.geometry.vertices.length; vertexIndex++)
                {
                var localVertex = MovingCube.geometry.vertices[vertexIndex].clone();
                var globalVertex = localVertex.applyMatrix4( MovingCube.matrix );
                var directionVector = globalVertex.sub( MovingCube.position );

                var ray = new THREE.Raycaster( originPoint, directionVector.clone().normalize() );
                var collisionResults = ray.intersectObjects( collidableMeshList );
                //if ( collisionResults.length > 0 && collisionResults[0].distance < directionVector.length() ){
                if ( collisionResults.length > 0 && collisionResults[0].distance < directionVector.length() ){
                //if ( collisionResults.length > 0 && collisionResults[0].distance < 0.5){
                appendText(" Hit ");
                console.log("hit");
                controls.movementSpeed -= controls.movementSpeed + controls.movementSpeed; //80
                //controls.movementSpeed -= controls.movementSpeed;
                //controls.movementSpeed = -100;
                //controls.movementSpeed = 0;
                console.log(controls.movementSpeed);
                //moveDistance -=moveDistance + moveDistance; //80
                moveDistance -=controls.movementSpeed;
                console.log(moveDistance);
                //break;
                }
                else {
                        //controls.movementSpeed = controls.movementSpeed + 1;
                        controls.movementSpeed = 80;
                        //controls.movementSpeed = 100;
                        moveDistance = moveDistance; 
                }
        }




        })
        
        //loop runner
        var lastTimeMsec= null
        requestAnimationFrame(function animate(nowMsec){
                // keep looping
                requestAnimationFrame( animate );
                // measure time
                lastTimeMsec        = lastTimeMsec || nowMsec-1000/60
                var deltaMsec        = Math.min(200, nowMsec - lastTimeMsec)
                lastTimeMsec        = nowMsec
                // call each update function
                updateFcts.forEach(function(updateFn){
                        updateFn(deltaMsec/1000, nowMsec/1000)
                })
        })
</script>
</div>
<div id="message"></div>
<p class="ce">Use Q, E keys to rotate the camera</p>
<p class="ce">Use the W, A, S, D keys to move around</p>
<p class="ce">WebGL renderer is supported in Firefox 4+, Chrome 9+, and Safari 6+</p>
<!--external sounds-->
<!--<audio autoplay loop><source src="gangsters2.mp3" type="audio/mp3"></audio>-->
</body>
</html>